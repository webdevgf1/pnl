<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop - P&L Card Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @font-face {
            font-family: 'Geist-Regular';
            src: url('./fonts/Geist-Regular.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Geist-Medium';
            src: url('./fonts/Geist-Medium.otf') format('opentype');
            font-weight: 500;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Geist-SemiBold';
            src: url('./fonts/Geist-SemiBold.otf') format('opentype');
            font-weight: 600;
            font-style: normal;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', sans-serif;
            background: linear-gradient(45deg, #008080 0%, #00ffff 50%, #008080 100%);
            background-size: 400% 400%;
            animation: desktopGradient 10s ease infinite;
            height: 100vh;
            overflow: hidden;
            cursor: default;
        }

        @keyframes desktopGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Desktop Icons */
        .desktop {
            position: relative;
            width: 100%;
            height: 100vh;
            padding: 20px;
        }

        .desktop-icon {
            position: absolute;
            width: 80px;
            text-align: center;
            cursor: pointer;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            user-select: none;
        }

        .desktop-icon:hover {
            background: rgba(0, 0, 255, 0.3);
            border: 1px dotted white;
        }

        .desktop-icon img {
            width: 48px;
            height: 48px;
            margin-bottom: 5px;
            image-rendering: pixelated;
        }

        .desktop-icon span {
            display: block;
            font-size: 11px;
            font-weight: bold;
        }

        .icon-twitter { top: 20px; left: 20px; }
        .icon-pumpfun { top: 20px; left: 120px; }

        /* Windows 98 Application Window */
        .window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            height: 85%;
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .title-bar {
            background: linear-gradient(90deg, #0000ff, #000080);
            color: white;
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            font-weight: bold;
        }

        .title-text {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .window-icon {
            width: 16px;
            height: 16px;
            background: #ffff00;
            border: 1px solid #000;
        }

        .window-controls {
            display: flex;
            gap: 2px;
        }

        .control-btn {
            width: 16px;
            height: 14px;
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            font-size: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:active {
            border: 1px inset #c0c0c0;
        }

        .window-content {
            flex: 1;
            padding: 10px;
            background: #c0c0c0;
            overflow-y: auto;
            display: flex;
            gap: 15px;
        }

        /* Form Section */
        .form-section {
            width: 300px;
            background: #f0f0f0;
            border: 2px inset #c0c0c0;
            padding: 15px;
            height: fit-content;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-size: 11px;
            font-weight: bold;
            color: #000;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 2px;
            border: 2px inset #c0c0c0;
            background: white;
            font-size: 11px;
            font-family: 'MS Sans Serif', sans-serif;
        }

        .form-group input:focus, .form-group select:focus {
            outline: 1px dotted #000;
        }

        .win98-button {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 4px 12px;
            font-size: 11px;
            font-family: 'MS Sans Serif', sans-serif;
            cursor: pointer;
            margin: 5px 0;
        }

        .win98-button:active {
            border: 2px inset #c0c0c0;
        }

        .win98-button.primary {
            background: #0000ff;
            color: white;
        }

        .background-section {
            border-top: 1px solid #808080;
            padding-top: 10px;
            margin-top: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 4px 12px;
            font-size: 11px;
            cursor: pointer;
            display: block;
            text-align: center;
        }

        .file-input-label:active {
            border: 2px inset #c0c0c0;
        }

        /* Preview Section */
        .preview-section {
            flex: 1;
            background: #f0f0f0;
            border: 2px inset #c0c0c0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: auto;
        }

        .card-container {
            margin: 20px 0;
        }

        .card-preview {
            width: 840px;
            height: 570px;
            position: relative;
            background-image: url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/683495c0f008abc19b88aaf3_FINALPNLCARDdddd.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 2px inset #c0c0c0;
            cursor: default;
        }

        .custom-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .pnl-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 2;
            pointer-events: none;
        }

        .profile-pic {
            position: absolute;
            top: 449px;
            left: 33px;
            width: 48px; /* 81 - 35 = 46px width */
            height: 51px; /* 498 - 452 = 46px height */
            border-radius: 6px;
            object-fit: cover;
            z-index: 3;
            display: none;
        }

        .draggable-text {
            position: absolute;
            user-select: none;
            pointer-events: none;
            z-index: 2;
            cursor: move;
            padding: 2px 4px;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .draggable-text:hover {
            border-color: #00fff9;
            background: rgba(0, 255, 249, 0.1);
        }

        .draggable-text.dragging {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .coin-name {
            font-family: 'Geist-Medium', 'Inter', sans-serif;
            font-weight: 500;
            font-size: 41px;
            color: white;
            top: 111px;
            left: 30px;
        }

        .ticker {
            font-family: 'Geist-SemiBold', 'Inter', sans-serif;
            font-weight: 600;
            font-size: 57px;
            color: black;
            top: 173px;
            left: 132px;
        }

        .invested-value {
            font-family: 'Geist-Regular', 'Inter', sans-serif;
            font-weight: 400;
            font-size: 28px;
            color: white;
            top: 325px;
            left: 292px;
        }

        .position-value {
            font-family: 'Geist-Regular', 'Inter', sans-serif;
            font-weight: 400;
            font-size: 28px;
            color: white;
            top: 366px;
            left: 292px;
        }

        .percentage {
            font-family: 'Geist-Regular', 'Inter', sans-serif;
            font-weight: 400;
            font-size: 27px;
            color: #2fe3ac;
            top: 286px;
            left: 278px;
        }

        .percentage.negative {
            color: #ff4444;
        }

        .username {
            font-family: 'Geist-Medium', 'Inter', sans-serif;
            font-weight: 500;
            font-size: 41px;
            color: white;
            top: 442px;
            left: 92px;
        }

        /* Taskbar */
        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #c0c0c0;
            border-top: 1px solid #808080;
            display: flex;
            align-items: center;
            padding: 0 5px;
            z-index: 1000;
        }

        .start-button {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .start-button:active {
            border: 2px inset #c0c0c0;
        }

        .taskbar-time {
            margin-left: auto;
            font-size: 11px;
            border: 1px inset #c0c0c0;
            padding: 2px 5px;
        }

        /* Status text */
        .status-text {
            font-size: 10px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .window {
                width: 95%;
                height: 90%;
            }
            
            .window-content {
                flex-direction: column;
            }
            
            .form-section {
                width: 100%;
            }
            
            .card-preview {
                width: 100%;
                max-width: 400px;
                height: 271px;
                transform: scale(0.48);
                transform-origin: top left;
            }
            
            .card-container {
                width: 400px;
                height: 271px;
                overflow: hidden;
            }
        }
    </style>
</head>
<body>
    <div class="desktop">
        <!-- Desktop Icons -->
        <div class="desktop-icon icon-twitter" onclick="openTwitter()">
            <img src="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6830acbd03f5e3b5fc93764a_new-2023-twitter-logo-x-icon-design_1017-45418.avif" alt="Twitter">
            <span>X/Twitter</span>
        </div>

        <div class="desktop-icon icon-pumpfun" onclick="openPumpFun()">
            <img src="https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/67e09302ce2c79cb6daaebcc_Pump_fun_logo%20(2).png" alt="Pump.fun">
            <span>Pump.fun</span>
        </div>

        <!-- Main Application Window -->
        <div class="window">
            <div class="title-bar">
                <div class="title-text">
                    <div class="window-icon"></div>
                    <span>P&L Card Generator - [Application]</span>
                </div>
                <div class="window-controls">
                    <div class="control-btn">_</div>
                    <div class="control-btn">□</div>
                    <div class="control-btn">×</div>
                </div>
            </div>

            <div class="window-content">
                <div class="form-section">
                    <div class="form-group">
                        <label for="coinName">Coin Name:</label>
                        <input type="text" id="coinName" value="FAKECOIN">
                    </div>
                    
                    <div class="form-group">
                        <label for="ticker">SOL Profit:</label>
                        <input type="text" id="ticker" value="22.52" readonly style="background: #e0e0e0; color: #666;">
                        <div style="font-size: 10px; color: #666; margin-top: 2px;">
                            Auto-calculated: Position - Invested
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="invested">Amount Invested:</label>
                        <input type="number" id="invested" step="0.01" value="1.98">
                    </div>
                    
                    <div class="form-group">
                        <label for="position">Current Position Value:</label>
                        <input type="number" id="position" step="0.01" value="24.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="username">Username/Handle:</label>
                        <input type="text" id="username" value="@TEMPLATE">
                    </div>

                    <div class="form-group">
                        <label for="pfpUpload">Profile Picture:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="pfpUpload" accept="image/*" onchange="handlePfpUpload(event)">
                            <label for="pfpUpload" class="file-input-label">
                                Choose Profile Pic...
                            </label>
                        </div>
                        <button class="win98-button" onclick="resetPfp()" style="width: 100%; margin-top: 5px;">
                            Remove Profile Pic
                        </button>
                    </div>

                    <div class="background-section">
                        <label>Custom Background:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="backgroundUpload" accept="image/*" onchange="handleBackgroundUpload(event)">
                            <label for="backgroundUpload" class="file-input-label">
                                Choose Image/GIF...
                            </label>
                        </div>
                        <button class="win98-button" onclick="resetBackground()" style="width: 100%; margin-top: 5px;">
                            Reset to Default
                        </button>
                    </div>

                    <div class="background-section">
                        <label>Position Mode:</label>
                        <button class="win98-button" id="positionMode" onclick="togglePositionMode()" style="width: 100%;">
                            Enable Position Mode
                        </button>
                        <div style="font-size: 10px; margin-top: 5px; color: #666;">
                            Enable to drag text elements for positioning
                        </div>
                    </div>
                    
                    <button class="win98-button primary" onclick="downloadCard()" style="width: 100%; margin-top: 15px;">
                        Download P&L Card
                    </button>
                </div>

                <div class="preview-section">
                    <h3 style="font-size: 12px; margin-bottom: 10px; color: #000;">Preview:</h3>
                    
                    <div class="card-container">
                        <div class="card-preview" id="cardPreview">
                            <img id="customBackground" class="custom-background" style="display: none;">
                            <img id="pnlOverlay" class="pnl-overlay" style="display: none;">
                            <img id="profilePic" class="profile-pic" style="display: none;">
                            
                            <div class="draggable-text coin-name" id="coinNameText" data-name="coinName">FAKECOIN</div>
                            <div class="draggable-text ticker" id="tickerText" data-name="ticker">22.52</div>
                            <div class="draggable-text invested-value" id="investedValue" data-name="investedValue">1.98</div>
                            <div class="draggable-text position-value" id="positionValue" data-name="positionValue">24.5</div>
                            <div class="draggable-text percentage" id="percentageText" data-name="percentage">1135.51%</div>
                            <div class="draggable-text username" id="usernameText" data-name="username">@TEMPLATE</div>
                        </div>
                    </div>

                    <div class="status-text">
                        Windows 98 Style • P&L Card Generator v1.0
                    </div>
                </div>
            </div>
        </div>

        <!-- Coordinates Display - Hidden by default -->
        <div id="coordinatesDisplay" style="position: fixed; bottom: 40px; left: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #00fff9; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 10px; z-index: 1001; max-height: 150px; overflow-y: auto; display: none;">
            <strong>Current Coordinates (top, left, right, bottom):</strong><br>
            <div id="coordList"></div>
        </div>
    </div>

    <!-- Taskbar -->
    <div class="taskbar">
    <button class="start-button">
        <span style="background: #008000; width: 12px; height: 12px; display: block;"></span>
        Start
    </button>
    <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 11px; color: #000; font-weight: bold;">CA: @FAKEPNL</span>
        <div class="taskbar-time" id="taskbarTime">12:00 PM</div>
    </div>
</div>

    <script>
        let customBackgroundSet = false;
        let profilePicSet = false;
        let positionModeEnabled = false;
        let isDragging = false;
        let currentElement = null;
        let offset = { x: 0, y: 0 };

        // Update taskbar time
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('taskbarTime').textContent = time;
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Desktop icon functions
        function openTwitter() {
            window.open('https://twitter.com', '_blank');
        }

        function openPumpFun() {
            window.open('https://pump.fun', '_blank');
        }

        // Position Mode Functions
        function togglePositionMode() {
            positionModeEnabled = !positionModeEnabled;
            const btn = document.getElementById('positionMode');
            const draggableElements = document.querySelectorAll('.draggable-text');
            const coordDisplay = document.getElementById('coordinatesDisplay');
            
            if (positionModeEnabled) {
                btn.textContent = 'Disable Position Mode';
                btn.style.background = '#ff6b6b';
                coordDisplay.style.display = 'block'; // Show coordinates when positioning
                draggableElements.forEach(el => {
                    el.style.pointerEvents = 'auto';
                });
                enableDragging();
            } else {
                btn.textContent = 'Enable Position Mode';
                btn.style.background = '#c0c0c0';
                coordDisplay.style.display = 'none'; // Hide coordinates when not positioning
                draggableElements.forEach(el => {
                    el.style.pointerEvents = 'none';
                    el.classList.remove('dragging');
                });
                disableDragging();
            }
            updateCoordinates();
        }

        function enableDragging() {
            const draggableElements = document.querySelectorAll('.draggable-text');
            
            draggableElements.forEach(element => {
                element.addEventListener('mousedown', startDrag);
            });
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function disableDragging() {
            const draggableElements = document.querySelectorAll('.draggable-text');
            
            draggableElements.forEach(element => {
                element.removeEventListener('mousedown', startDrag);
            });
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function startDrag(e) {
            if (!positionModeEnabled) return;
            
            isDragging = true;
            currentElement = e.target;
            currentElement.classList.add('dragging');
            
            const rect = currentElement.getBoundingClientRect();
            const cardRect = document.getElementById('cardPreview').getBoundingClientRect();
            
            offset.x = e.clientX - rect.left;
            offset.y = e.clientY - rect.top;
            
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !currentElement) return;
            
            const cardRect = document.getElementById('cardPreview').getBoundingClientRect();
            
            let newX = e.clientX - cardRect.left - offset.x;
            let newY = e.clientY - cardRect.top - offset.y;
            
            // Keep element within card bounds
            newX = Math.max(0, Math.min(newX, 840 - currentElement.offsetWidth));
            newY = Math.max(0, Math.min(newY, 570 - currentElement.offsetHeight));
            
            currentElement.style.left = newX + 'px';
            currentElement.style.top = newY + 'px';
            currentElement.style.right = 'auto';
            currentElement.style.bottom = 'auto';
            
            updateCoordinates();
        }

        function stopDrag() {
            if (currentElement) {
                currentElement.classList.remove('dragging');
            }
            isDragging = false;
            currentElement = null;
        }

        function updateCoordinates() {
            const coordList = document.getElementById('coordList');
            const elements = document.querySelectorAll('.draggable-text');
            let coordText = '';
            
            elements.forEach(element => {
                const name = element.dataset.name;
                const top = Math.round(element.offsetTop);
                const left = Math.round(element.offsetLeft);
                const right = Math.round(840 - element.offsetLeft - element.offsetWidth);
                const bottom = Math.round(570 - element.offsetTop - element.offsetHeight);
                
                coordText += `<div>${name}: top: ${top}px, left: ${left}px, right: ${right}px, bottom: ${bottom}px</div>`;
            });
            
            coordList.innerHTML = coordText;
        }

        // Background upload functionality
        function handleBackgroundUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const customBg = document.getElementById('customBackground');
                    customBg.src = e.target.result;
                    customBg.style.display = 'block';
                    customBackgroundSet = true;
                    updatePnlOverlay(); // Update overlay when background changes
                };
                reader.readAsDataURL(file);
            }
        }

        function resetBackground() {
            const customBg = document.getElementById('customBackground');
            const pnlOverlay = document.getElementById('pnlOverlay');
            customBg.style.display = 'none';
            customBg.src = '';
            pnlOverlay.style.display = 'none';
            pnlOverlay.src = '';
            customBackgroundSet = false;
            document.getElementById('backgroundUpload').value = '';
        }

        function resetPfp() {
            const profilePic = document.getElementById('profilePic');
            const cardPreview = document.getElementById('cardPreview');
            
            profilePic.style.display = 'none';
            profilePic.src = '';
            profilePicSet = false;
            document.getElementById('pfpUpload').value = '';
            
            // Switch to background without orange square
            cardPreview.style.backgroundImage = "url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6834abe3c3dd94c4b9edb035_FINALPNLCARDdddd%20(1).png')";
        }

        function handlePfpUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const profilePic = document.getElementById('profilePic');
            const cardPreview = document.getElementById('cardPreview');
            
            profilePic.src = e.target.result;
            profilePic.style.display = 'block';
            profilePicSet = true;
            
            // Always switch to background without orange square when pfp is uploaded
            if (!customBackgroundSet) {
                cardPreview.style.backgroundImage = "url('https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6834abe3c3dd94c4b9edb035_FINALPNLCARDdddd%20(1).png')";
            }
        };
        reader.readAsDataURL(file);
    }
}

        function updatePnlOverlay() {
            if (!customBackgroundSet) return;
            
            const invested = parseFloat(document.getElementById('invested').value) || 1.98;
            const position = parseFloat(document.getElementById('position').value) || 24.5;
            const percentage = invested > 0 ? ((position - invested) / invested * 100) : 0;
            const isProfit = percentage >= 0;
            
            const pnlOverlay = document.getElementById('pnlOverlay');
            
            if (isProfit) {
                // Use green profit overlay
                pnlOverlay.src = 'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6834a8a45948936715329db3_customwinner.png';
            } else {
                // Use red loss overlay
                pnlOverlay.src = 'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/6834a8a45948936715329daf_customloser.png';
            }
            
            pnlOverlay.style.display = 'block';
        }

        function updatePreview() {
            const coinName = document.getElementById('coinName').value || 'FAKECOIN';
            const invested = parseFloat(document.getElementById('invested').value) || 1.98;
            const position = parseFloat(document.getElementById('position').value) || 24.5;
            const username = document.getElementById('username').value || '@TEMPLATE';
            
            // Calculate SOL profit (position - invested)
            const solProfit = position - invested;
            const ticker = solProfit.toFixed(2);
            
            // Calculate percentage
            const percentage = invested > 0 ? ((position - invested) / invested * 100) : 0;
            const isPositive = percentage >= 0;
            
            // Update preview
            document.getElementById('coinNameText').textContent = coinName.toUpperCase();
            document.getElementById('tickerText').textContent = ticker;
            document.getElementById('ticker').value = ticker; // Update the input field
            document.getElementById('investedValue').textContent = `${invested.toFixed(2)}`;
            document.getElementById('positionValue').textContent = `${position.toFixed(2)}`;
            document.getElementById('usernameText').textContent = username;
            
            const percentageElement = document.getElementById('percentageText');
            percentageElement.textContent = `${isPositive ? '+' : ''}${percentage.toFixed(2)}%`;
            percentageElement.className = `draggable-text percentage ${isPositive ? '' : 'negative'}`;
            
            // Update PNL overlay if custom background is set
            updatePnlOverlay();
        }

        async function downloadCard() {
            try {
                // Get the card preview element
                const cardElement = document.getElementById('cardPreview');
                
                // Use html2canvas to capture the exact preview
                const canvas = await html2canvas(cardElement, {
                    width: 840,
                    height: 570,
                    scale: 1,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false
                });
                
                // Get current values for filename
                const coinName = document.getElementById('coinName').value || 'FAKECOIN';
                
                // Download the screenshot
                const link = document.createElement('a');
                link.download = `${coinName}_PNL_Card.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
            } catch (error) {
                console.error('Screenshot failed:', error);
                // Fallback to manual canvas method if html2canvas fails
                downloadCardManual();
            }
        }

        async function downloadCardManual() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 840;
            canvas.height = 570;
            
            // Get current values
            const coinName = document.getElementById('coinName').value || 'FAKECOIN';
            const ticker = document.getElementById('ticker').value || '22.52';
            const invested = parseFloat(document.getElementById('invested').value) || 1.98;
            const position = parseFloat(document.getElementById('position').value) || 24.5;
            const username = document.getElementById('username').value || '@TEMPLATE';
            const percentage = invested > 0 ? ((position - invested) / invested * 100) : 0;
            const isPositive = percentage >= 0;
            
            // Determine which background to use
            const customBg = document.getElementById('customBackground');
            const backgroundSrc = customBackgroundSet && customBg.src ? 
                customBg.src : 
                'https://cdn.prod.website-files.com/6740d85c4e3daeef29a89470/683495c0f008abc19b88aaf3_FINALPNLCARDdddd.png';
            
            // Load and draw background image
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            return new Promise((resolve) => {
                img.onload = function() {
                    // Draw background (will resize to fit)
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'hanging';
                    
                    // Get current positions of all elements and use them for download
                    const elements = {
                        coinName: document.getElementById('coinNameText'),
                        ticker: document.getElementById('tickerText'),
                        investedValue: document.getElementById('investedValue'),
                        positionValue: document.getElementById('positionValue'),
                        percentage: document.getElementById('percentageText'),
                        username: document.getElementById('usernameText')
                    };
                    
                    // Draw text at current element positions
                    ctx.font = '500 41px Geist-Medium, Inter, sans-serif';
                    ctx.fillStyle = 'white';
                    ctx.fillText(coinName.toUpperCase(), elements.coinName.offsetLeft, elements.coinName.offsetTop);
                    
                    ctx.font = '600 57px Geist-SemiBold, Inter, sans-serif';
                    ctx.fillStyle = 'black';
                    ctx.fillText(ticker.toUpperCase(), elements.ticker.offsetLeft, elements.ticker.offsetTop);
                    
                    ctx.font = '400 28px Geist-Regular, Inter, sans-serif';
                    ctx.fillStyle = 'white';
                    ctx.fillText(`${invested.toFixed(2)}`, elements.investedValue.offsetLeft, elements.investedValue.offsetTop);
                    ctx.fillText(`${position.toFixed(2)}`, elements.positionValue.offsetLeft, elements.positionValue.offsetTop);
                    
                    ctx.font = '400 27px Geist-Regular, Inter, sans-serif';
                    ctx.fillStyle = isPositive ? '#2fe3ac' : '#ff4444';
                    ctx.fillText(`${isPositive ? '+' : ''}${percentage.toFixed(2)}%`, elements.percentage.offsetLeft, elements.percentage.offsetTop);
                    
                    ctx.font = '500 41px Geist-Medium, Inter, sans-serif';
                    ctx.fillStyle = 'white';
                    ctx.fillText(username, elements.username.offsetLeft, elements.username.offsetTop);
                    
                    // Download
                    const link = document.createElement('a');
                    link.download = `${coinName}_PNL_Card.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    
                    resolve();
                };
                
                img.src = backgroundSrc;
            });
        }
        
        // Add event listeners (removed ticker input listener since it's auto-calculated)
        document.getElementById('coinName').addEventListener('input', updatePreview);
        document.getElementById('invested').addEventListener('input', updatePreview);
        document.getElementById('position').addEventListener('input', updatePreview);
        document.getElementById('username').addEventListener('input', updatePreview);
        
        // Initialize
        updatePreview();
        updateCoordinates();
    </script>
</body>
</html>
